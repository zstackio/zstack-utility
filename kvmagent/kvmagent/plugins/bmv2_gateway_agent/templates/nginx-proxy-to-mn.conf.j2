user nginx;

worker_processes auto;

error_log {{ zstack_bm_nginx_log_dir }}/error.log;

pid {{ zstack_bm_nginx_pid }};

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    access_log          {{ zstack_bm_nginx_log_dir }}/access.log;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   1000;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen  7090;

        location /baremetal_instance_agent/v2/callback {
            proxy_set_header Host $host;

            proxy_pass {{ mn_callback_uri }}/zstack/asyncrest/callback;
        }

        location /baremetal_instance_agent/v2/hardwareinfos {
            proxy_set_header Host $host;

            proxy_pass {{ mn_callback_uri }}/zstack/v1/baremetal2/chassis/ipmi/hardwareinfos;
        }

        location /httpboot {
            autoindex on;
            autoindex_exact_size on;
            autoindex_localtime on;
            root {{ bm_gateway_httpboot }};
        }

        include {{ bm_agent_proxy_conf_dir }}/*.http;
    }
}

stream {
    include {{ bm_agent_proxy_conf_dir }}/*.tcp;
}